#!/bin/bash
# Git pre-commit hook - æ—¥ä»˜ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯

echo "ğŸ” æ—¥ä»˜ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

# ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸPythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|json)$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
HAS_ERROR=0
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå†…å®¹ã‚’å‡ºåŠ›
        git show ":$FILE" > /tmp/check_dates_temp
        
        # ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        if ! python3 scripts/check_dates.py /tmp/check_dates_temp > /dev/null 2>&1; then
            echo "âŒ $FILE ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸæ—¥ä»˜ãŒã‚ã‚Šã¾ã™"
            python3 scripts/check_dates.py "$FILE" 2>/dev/null | grep "è¡Œ"
            HAS_ERROR=1
        fi
        
        rm -f /tmp/check_dates_temp
    fi
done

if [ $HAS_ERROR -eq 1 ]; then
    echo ""
    echo "âš ï¸  ã‚³ãƒŸãƒƒãƒˆã‚’ä¸­æ­¢ã—ã¾ã—ãŸ"
    echo "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: scripts/date_utils.py ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
    echo ""
    echo "ä¾‹:"
    echo "  from scripts.date_utils import get_today, get_now"
    echo "  date = get_today()  # 2025-06-13"
    echo ""
    exit 1
fi

echo "âœ… æ—¥ä»˜ãƒã‚§ãƒƒã‚¯å®Œäº†"
exit 0